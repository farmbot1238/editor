<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farm Bot - Editor Mode</title>
<style>
:root {
    --glass: rgba(0,0,0,0.55);
    --white: #fff;
    --green: #1b5e20;
    --yellow: #ffeb3b;
    --black: #000;
    --hover-green: #4caf50;
    --purple: #7b1fa2;
    --hover-purple: #9c27b0;
    --edit-blue: #2196f3;
    --edit-hover: #1976d2;
    --delete-red: #f44336;
}
* { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }
body, html { height: 100%; scroll-behavior: smooth; }

/* ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ */
.login-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg, var(--green), var(--edit-blue));
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}
.login-box {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    text-align: center;
    width: 90%;
    max-width: 400px;
}
.login-box h1 {
    color: var(--green);
    margin-bottom: 30px;
}
.login-input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}
.login-btn {
    width: 100%;
    padding: 12px;
    background: var(--green);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
    font-weight: bold;
}
.login-btn:hover {
    background: var(--hover-green);
}
.login-error {
    color: var(--delete-red);
    margin-top: 10px;
    display: none;
}

/* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± */
.editor-header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, var(--edit-blue), var(--purple));
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 9999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.editor-title {
    font-weight: bold;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}
.editor-controls {
    display: flex;
    gap: 8px;
}
.editor-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.editor-btn:hover {
    background: rgba(255,255,255,0.3);
}
.save-btn {
    background: var(--green);
}
.save-btn:hover {
    background: var(--hover-green);
}
.logout-btn {
    background: var(--delete-red);
}
.logout-btn:hover {
    background: #d32f2f;
}

/* ÿ±ÿ≥ÿßÿ¶ŸÑ */
.message {
    position: fixed;
    top: 60px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 10000;
    display: none;
    animation: slideIn 0.3s ease;
}
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.message.show {
    display: block;
}
.message.success {
    background: #4caf50;
}
.message.error {
    background: var(--delete-red);
}
.message.info {
    background: var(--edit-blue);
}

/* ÿßŸÑŸÖŸàŸÇÿπ ŸÜŸÅÿ≥Ÿá (ŸÜŸÅÿ≥ ÿ£ŸÜŸÖÿßÿ∑ index.html) */
.home {
    background: url('FARBOT.jpeg') no-repeat center center/cover;
    height: 100vh;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    color: var(--white); text-align:center;
    margin-top: 60px;
}
.glass-box { background: var(--glass); padding:30px; border-radius:15px; max-width:600px; width:90%; }
h1 { font-size:2rem; margin-bottom:15px; }
.menu { margin:20px 0; }
.menu button {
    display:block; width:200px; margin:10px auto; padding:12px; font-size:1rem;
    border:none; border-radius:10px; background: var(--green); color: var(--white); cursor:pointer; transition:0.3s;
}
.menu button:hover { background: var(--hover-green); box-shadow: 0 0 15px var(--hover-green); }

#suggestions {
    background: var(--black); padding:30px; border-radius:15px 15px 0 0; margin:0; width:100%;
    color: var(--white); text-align:center;
}
#suggestions h2 { margin-bottom:10px; }
#suggestions p { margin-bottom:20px; }
#suggestions input, #suggestions button { padding:10px; margin:5px; border:none; border-radius:8px; }
#suggestions input { width:250px; }
#suggestions button { background: var(--green); color: var(--white); cursor:pointer; }
#suggestions button:hover { background: var(--hover-green); }

.page {
    display:none;
    background: url('FARBOT2.jpeg') no-repeat center center/cover;
    background-size: cover;
    height:100vh; padding:40px; color: var(--white); overflow-y:auto;
    margin-top: 60px;
}
.page .content {
    background: var(--glass); padding:20px; border-radius:15px; max-width:800px; margin:auto;
}
.page button { margin-top:20px; padding:10px 20px; background: var(--green); border:none; border-radius:8px; color: var(--white); cursor:pointer; }
.page button:hover { background: var(--hover-green); }

.lang-toggle { 
    position:absolute; 
    top:80px;
    right:20px; 
    background: var(--glass); 
    color: var(--white); 
    border:none; 
    padding:8px 15px; 
    border-radius:10px; 
    cursor:pointer; 
    z-index: 9998;
}

.threeD-title { font-size:2rem; text-align:center; margin-bottom:15px; }
.threeD-title .farm { color: var(--yellow); }
.threeD-title .bot { color: var(--green); }
.teachable-title { font-size:2rem; text-align:center; margin-bottom:15px; }
.teachable-title .teachable { color: var(--yellow); }
.teachable-title .machine { color: var(--purple); }
.functions-list { text-align: left; margin: 20px 0; }
.function-item { 
    margin: 15px 0; 
    padding: 10px; 
    background: rgba(255,255,255,0.1); 
    border-radius: 8px;
    position: relative;
}

.pdf-download-btn {
    display: inline-block;
    margin: 15px 0;
    padding: 12px 25px;
    background: #d32f2f;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    transition: background 0.3s;
}
.pdf-download-btn:hover { background: #b71c1c; }
.pdf-icon { margin-right: 8px; }
.teachable-btn {
    display: inline-block;
    margin: 15px 0;
    padding: 12px 25px;
    background: var(--purple);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    transition: background 0.3s;
    border: none;
    cursor: pointer;
}
.teachable-btn:hover { background: var(--hover-purple); box-shadow: 0 0 15px var(--hover-purple); }
.teachable-icon { margin-right: 8px; }
.instagram-link {
    display: inline-block;
    margin-top: 20px;
    color: var(--white);
    text-decoration: none;
    font-size: 1.1rem;
    transition: color 0.3s;
}
.instagram-link:hover { color: #e4405f; }
.instagram-icon { margin-right: 8px; font-size: 1.2rem; }

/* ÿπŸÜÿßÿµÿ± ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿ≠ÿ±Ÿäÿ± */
.editable {
    cursor: pointer;
    position: relative;
    transition: all 0.3s;
    padding: 2px 4px;
    border-radius: 3px;
}
.editable:hover {
    background: rgba(33, 150, 243, 0.2);
    outline: 2px dashed var(--edit-blue);
}
.editable::after {
    content: '‚úèÔ∏è';
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--edit-blue);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
}
.editable:hover::after {
    opacity: 1;
}

/* ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ */
.files-management {
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}
.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.files-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 15px 0;
}
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid transparent;
}
.file-item.active {
    border-left-color: #4caf50;
    background: rgba(76, 175, 80, 0.1);
}
.file-info {
    flex: 1;
}
.file-name {
    font-weight: bold;
    margin-bottom: 5px;
}
.file-details {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    display: flex;
    gap: 15px;
}
.file-actions {
    display: flex;
    gap: 8px;
}
.file-action-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.file-action-btn:hover {
    background: rgba(255,255,255,0.2);
}
.set-active-btn {
    background: var(--green);
}
.delete-file-btn {
    background: var(--delete-red);
}

/* ŸÇÿ≥ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ */
.upload-section {
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border: 2px dashed var(--edit-blue);
}
.upload-area {
    text-align: center;
    padding: 30px;
    cursor: pointer;
    transition: all 0.3s;
    border-radius: 8px;
}
.upload-area:hover {
    background: rgba(33, 150, 243, 0.1);
}
.upload-icon {
    font-size: 40px;
    margin-bottom: 10px;
    color: var(--edit-blue);
}
.upload-instructions {
    font-size: 14px;
    color: rgba(255,255,255,0.7);
    margin-top: 10px;
}

/* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± */
.edit-modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20000;
}
.edit-modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}
.edit-modal h3 {
    color: var(--edit-blue);
    margin-bottom: 20px;
    text-align: center;
}
.edit-textarea {
    width: 100%;
    height: 150px;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
    resize: vertical;
    font-family: Arial, sans-serif;
}
.edit-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 15px;
}
.edit-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* ÿ£ÿ≤ÿ±ÿßÿ± ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ */
.section-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
}
.section-btn {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.edit-section-btn {
    background: var(--edit-blue);
    color: white;
}
.delete-section-btn {
    background: var(--delete-red);
    color: white;
}

/* ÿ¥ÿ±Ÿäÿ∑ ÿ™ŸÇÿØŸÖ ÿßŸÑÿ±ŸÅÿπ */
.progress-container {
    margin: 15px 0;
    display: none;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--edit-blue), #4caf50);
    width: 0%;
    transition: width 0.3s;
    border-radius: 10px;
}
.progress-text {
    text-align: center;
    margin-top: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
<div id="loginScreen" class="login-overlay">
    <div class="login-box">
        <h1>üîê Farm Bot Editor</h1>
        <p style="color: #666; margin-bottom: 20px;">Enter password to edit website</p>
        <input type="password" id="passwordInput" class="login-input" placeholder="Enter password" autofocus>
        <button onclick="login()" class="login-btn">Login</button>
        <p id="loginError" class="login-error">Wrong password! Try: admin123</p>
        <p style="margin-top: 15px; font-size: 12px; color: #888;">Default password: admin123</p>
    </div>
</div>

<!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± -->
<div id="editorHeader" class="editor-header" style="display: none;">
    <div class="editor-title">
        <span>‚úèÔ∏è</span>
        <span>Editor Mode</span>
    </div>
    <div class="editor-controls">
        <button class="editor-btn save-btn" onclick="saveAllChanges()">
            <span>üíæ</span>
            <span>Save All</span>
        </button>
        <button class="editor-btn" onclick="openPage('download')">
            <span>üìÅ</span>
            <span>Manage PDFs</span>
        </button>
        <button class="editor-btn logout-btn" onclick="logout()">
            <span>üö™</span>
            <span>Logout</span>
        </button>
    </div>
</div>

<div id="message" class="message"></div>

<!-- ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ (ŸÜŸÅÿ≥ index.html ŸÖÿπ ÿ•ÿ∂ÿßŸÅÿ© class="editable") -->
<section class="home" id="home" style="display: none;">
    <button class="lang-toggle" onclick="toggleLang()">AR</button>
    <div class="glass-box">
        <h1 id="title" class="editable" onclick="editText('main_title', this)">FARM 8OT</h1>
        <p id="subtitle" class="editable" onclick="editText('main_subtitle', this)">Revolution in the world of agriculture</p>
        <div class="menu">
            <button onclick="openPage('about')" id="about-btn">About</button>
            <button onclick="openPage('what')" id="what-btn">What it does</button>
            <button id="contact-btn">Contact</button>
            <button onclick="open3DPage()" id="threeD-btn">3D</button>
            <button onclick="openPage('teachable')" id="teachable-btn">Teachable Machine Model</button>
            <button onclick="openPage('download')" id="download-btn">Download PDF</button>
        </div>
        <a href="#" id="instagram-link" class="instagram-link" target="_blank">
            <span class="instagram-icon">üì∑</span>
            <span id="instagram-text" class="editable" onclick="editText('instagram_text', this)">Follow us on Instagram</span>
        </a>
    </div>
</section>

<div id="suggestions" style="display: none;">
    <h2 id="suggest-title" class="editable" onclick="editText('suggest_title', this)">Suggestions</h2>
    <p id="suggest-text" class="editable" onclick="editText('suggest_text', this)">We believe in any suggestion that can develop and enhance our project.</p>
    <p><strong id="phone-text" class="editable" onclick="editText('phone_text', this)">Phone:</strong> 
       <span id="phone-number" class="editable" onclick="editText('contact_phone', this)">+962 7XXXXXXXX</span>
    </p>
    <form onsubmit="event.preventDefault(); sendSuggestion();">
        <input type="text" id="suggest-input" placeholder="Write your suggestion..." required>
        <button type="submit" id="send-btn">Send</button>
    </form>
</div>

<section class="page" id="about" style="display: none;">
    <div class="content">
        <h2 id="about-page-title" class="editable" onclick="editText('about_title', this)">About</h2>
        <p id="about-text" class="editable" onclick="editText('about_text', this)">Loading...</p>
        <button onclick="closePage('about')" id="exit-about-btn">Exit</button>
    </div>
</section>

<section class="page" id="what" style="display: none;">
    <div class="content">
        <h2 id="what-title" class="editable" onclick="editText('what_title', this)">What it does</h2>
        <div class="functions-list" id="functions-content">
            Loading...
        </div>
        <div style="text-align: center; margin: 20px 0;">
            <button class="editor-btn" onclick="addNewSection('what')">
                <span>‚ûï</span>
                <span>Add New Function</span>
            </button>
        </div>
        <button onclick="closePage('what')" id="exit-what-btn">Exit</button>
    </div>
</section>

<section class="page" id="teachable" style="display: none;">
    <div class="content">
        <h2 class="teachable-title" id="teachable-page-title">
            <span class="teachable editable" onclick="editText('teachable_title_part1', this)">Teachable</span> 
            <span class="machine editable" onclick="editText('teachable_title_part2', this)">Machine</span>
        </h2>
        <p id="teachable-text" class="editable" onclick="editText('teachable_text', this)">Loading...</p>
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="openTeachableModel()" class="teachable-btn">
                <span class="teachable-icon">ü§ñ</span>
                <span id="teachable-btn-text" class="editable" onclick="editText('teachable_btn_text', this)">Open Teachable Machine Model</span>
            </button>
        </div>
        <div id="teachable-info">
            <h3 id="features-title" class="editable" onclick="editText('features_title', this)">Features:</h3>
            <div class="functions-list" id="teachable-features">
                Loading...
            </div>
        </div>
        <div style="text-align: center; margin: 20px 0;">
            <button class="editor-btn" onclick="addNewSection('teachable')">
                <span>‚ûï</span>
                <span>Add New Feature</span>
            </button>
        </div>
        <p id="teachable-note" class="editable" onclick="editText('teachable_note', this)">Loading...</p>
        <button onclick="closePage('teachable')" id="exit-teachable-btn">Exit</button>
    </div>
</section>

<section class="page" id="download" style="display: none;">
    <div class="content">
        <h2 id="download-title" class="editable" onclick="editText('download_title', this)">Download</h2>
        <p id="download-text" class="editable" onclick="editText('download_text', this)">Loading...</p>
        
        <!-- ŸÖŸÑŸÅ PDF ÿßŸÑŸÜÿ¥ÿ∑ ÿßŸÑÿ≠ÿßŸÑŸä -->
        <div id="activeFileSection" class="files-management" style="display: none;">
            <div class="files-header">
                <h4>üì• Active PDF File (Visible to Visitors)</h4>
            </div>
            <div id="activeFileInfo"></div>
        </div>
        
        <!-- ŸÇÿßÿ¶ŸÖÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™ -->
        <div id="allFilesSection" class="files-management">
            <div class="files-header">
                <h4>üìö All PDF Files</h4>
                <span id="filesCount">0 files</span>
            </div>
            <div id="filesList" class="files-list">
                <!-- ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
            </div>
        </div>
        
        <!-- ŸÇÿ≥ŸÖ ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ -->
        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üì§</div>
                <h3>Upload New PDF</h3>
                <p>Click to select a PDF file</p>
                <p class="upload-instructions">Max file size: 10MB ‚Ä¢ You can upload multiple files</p>
            </div>
            <input type="file" id="fileInput" accept=".pdf" style="display: none;" onchange="handleFileSelect(this.files[0])">
            
            <div id="uploadProgress" class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">Uploading...</div>
            </div>
        </div>
        
        <a href="#" id="pdf-download-link" class="pdf-download-btn" download>
            <span class="pdf-icon">üìÑ</span>
            <span id="download-btn-text" class="editable" onclick="editText('download_btn_text', this)">Download Farm Bot PDF</span>
        </a>
        
        <p id="file-info" class="editable" onclick="editText('file_info', this)">Loading...</p>
        
        <button onclick="closePage('download')" id="exit-download-btn">Exit</button>
    </div>
</section>

<!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± -->
<div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
        <h3 id="editModalTitle">Edit Text</h3>
        <textarea id="editModalTextarea" class="edit-textarea" placeholder="Enter text..."></textarea>
        <div class="edit-buttons">
            <button class="editor-btn" onclick="closeEditModal()">Cancel</button>
            <button class="editor-btn save-btn" onclick="saveEditedText()">Save</button>
        </div>
    </div>
</div>

<!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ -->
<div id="addSectionModal" class="edit-modal">
    <div class="edit-modal-content">
        <h3 id="addSectionTitle">Add New Section</h3>
        <input type="text" id="sectionTitleInput" class="edit-input" placeholder="Section Title">
        <textarea id="sectionContentInput" class="edit-textarea" placeholder="Section Content"></textarea>
        <div class="edit-buttons">
            <button class="editor-btn" onclick="closeAddSectionModal()">Cancel</button>
            <button class="editor-btn save-btn" onclick="saveNewSection()">Add Section</button>
        </div>
    </div>
</div>

<!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ -->
<div id="confirmDeleteModal" class="edit-modal">
    <div class="edit-modal-content">
        <h3>üóëÔ∏è Confirm Delete</h3>
        <p id="deleteMessage">Are you sure you want to delete this file?</p>
        <div class="edit-buttons">
            <button class="editor-btn" onclick="closeDeleteModal()">Cancel</button>
            <button class="editor-btn logout-btn" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<script>
// ============ ÿ•ÿπÿØÿßÿØÿßÿ™ Supabase ============
const SUPABASE_URL = 'https://etwthswhhplfnvejhofu.supabase.co';
const SUPABASE_KEY = 'sb_publishable_7nzi8jmfH7ONhR-7GJKxOg_xKS77RnY';

// ============ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿßŸÑŸÖÿ≠ÿ±ÿ± ============
const EDITOR_PASSWORD = "admin123"; // ÿ∫Ÿäÿ±Ÿáÿß ÿ•ÿ∞ÿß ÿ®ÿØŸÉ

// ============ ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ============
let textData = { en: {}, ar: {} };
let currentLang = 'en';
let websiteSections = [];
let websiteFiles = [];
let unsavedChanges = {};
let currentEditElement = null;
let currentEditKey = null;
let currentPageForSection = null;
let supabaseClient = null;
let activePdfFile = null;
let allPdfFiles = [];
let fileToDelete = null;

// ============ ŸÜÿ∏ÿßŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ============
function login() {
    const password = document.getElementById('passwordInput').value;
    const errorElement = document.getElementById('loginError');
    
    if (password === EDITOR_PASSWORD) {
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÜÿßÿ¨ÿ≠
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('editorHeader').style.display = 'flex';
        document.getElementById('home').style.display = 'flex';
        document.getElementById('suggestions').style.display = 'block';
        
        // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØÿÆŸàŸÑ
        localStorage.setItem('editor_logged_in', 'true');
        localStorage.setItem('editor_password', EDITOR_PASSWORD);
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        initializeSupabase();
        
        showMessage('Welcome to Editor Mode!', 'success');
    } else {
        errorElement.style.display = 'block';
        errorElement.textContent = 'Wrong password! Try: ' + EDITOR_PASSWORD;
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('editor_logged_in');
        localStorage.removeItem('editor_password');
        window.location.href = 'index.html';
    }
}

// ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
if (localStorage.getItem('editor_logged_in') === 'true' && 
    localStorage.getItem('editor_password') === EDITOR_PASSWORD) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('editorHeader').style.display = 'flex';
    document.getElementById('home').style.display = 'flex';
    document.getElementById('suggestions').style.display = 'block';
    initializeSupabase();
}

// ============ ÿ™ŸáŸäÿ¶ÿ© Supabase ============
function initializeSupabase() {
    // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÉÿ™ÿ®ÿ© Supabase
    if (!window.supabase) {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2';
        script.onload = function() {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            loadAllData();
        };
        script.onerror = function() {
            showMessage('Error loading Supabase library', 'error');
            loadDefaultData();
        };
        document.head.appendChild(script);
    } else {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        loadAllData();
    }
}

// ============ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ============
async function loadAllData() {
    showMessage('Loading data...', 'info');
    
    try {
        // 1. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿµŸàÿµ
        const { data: texts, error: textsError } = await supabaseClient
            .from('website_texts')
            .select('*');
        
        if (textsError) throw textsError;
        
        // 2. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
        const { data: sections, error: sectionsError } = await supabaseClient
            .from('website_sections')
            .select('*')
            .order('order_index');
        
        if (sectionsError) {
            console.warn('Could not load sections:', sectionsError);
            websiteSections = [];
        } else {
            websiteSections = sections || [];
        }
        
        // 3. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™
        const { data: files, error: filesError } = await supabaseClient
            .from('website_files')
            .select('*');
        
        if (filesError) {
            console.warn('Could not load files:', filesError);
            websiteFiles = [];
        } else {
            websiteFiles = files || [];
            updatePdfFiles();
        }
        
        // ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        organizeData(texts);
        
        showMessage('Data loaded successfully!', 'success');
        
    } catch (error) {
        console.error('Error loading data:', error);
        showMessage('Error loading data', 'error');
        loadDefaultData();
    }
}

function organizeData(texts) {
    textData = { en: {}, ar: {} };
    
    if (texts && texts.length > 0) {
        texts.forEach(item => {
            if (item.key) {
                textData.en[item.key] = item.value_en || item.value || '';
                textData.ar[item.key] = item.value_ar || item.value || item.value_en || '';
            }
        });
    }
    
    updateWebsiteContent();
}

// ============ ÿ•ÿØÿßÿ±ÿ© ŸÖŸÑŸÅÿßÿ™ PDF ============
function updatePdfFiles() {
    // ŸÅÿµŸÑ ŸÖŸÑŸÅÿßÿ™ PDF ÿπŸÜ ÿ®ÿßŸÇŸä ÿßŸÑŸÖŸÑŸÅÿßÿ™
    allPdfFiles = websiteFiles.filter(f => f.file_type === 'pdf');
    
    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿ¥ÿ∑ (ÿßŸÑÿ£ŸàŸÑ ÿ•ÿ∞ÿß ŸÖÿß ŸÅŸä ŸÖŸÑŸÅ ŸÖÿ≠ÿØÿØ ŸÉŸÜÿ¥ÿ∑)
    activePdfFile = allPdfFiles.length > 0 ? allPdfFiles[0] : null;
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
    updateFilesDisplay();
    updatePdfDownloadLink();
}

function updateFilesDisplay() {
    const filesList = document.getElementById('filesList');
    const filesCount = document.getElementById('filesCount');
    const activeFileSection = document.getElementById('activeFileSection');
    const activeFileInfo = document.getElementById('activeFileInfo');
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿØ ÿßŸÑŸÖŸÑŸÅÿßÿ™
    filesCount.textContent = `${allPdfFiles.length} file${allPdfFiles.length !== 1 ? 's' : ''}`;
    
    // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÜÿ¥ÿ∑
    if (activePdfFile) {
        activeFileSection.style.display = 'block';
        
        const fileSize = activePdfFile.file_size || 'Unknown';
        const uploadDate = new Date(activePdfFile.uploaded_at).toLocaleDateString();
        
        activeFileInfo.innerHTML = `
            <div class="file-item active">
                <div class="file-info">
                    <div class="file-name">${activePdfFile.file_name}</div>
                    <div class="file-details">
                        <span>Size: ${fileSize}</span>
                        <span>Uploaded: ${uploadDate}</span>
                        <span style="color: #4caf50;">‚úì Active</span>
                    </div>
                </div>
                <div class="file-actions">
                    <button class="file-action-btn" title="Download" onclick="downloadFile('${activePdfFile.file_url}', '${activePdfFile.file_name}')">
                        ‚¨áÔ∏è
                    </button>
                </div>
            </div>
        `;
    } else {
        activeFileSection.style.display = 'none';
    }
    
    // ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÑŸÅÿßÿ™
    filesList.innerHTML = '';
    
    if (allPdfFiles.length === 0) {
        filesList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">No PDF files uploaded yet</p>';
        return;
    }
    
    allPdfFiles.forEach(file => {
        const isActive = activePdfFile && file.id === activePdfFile.id;
        const fileSize = file.file_size || 'Unknown';
        const uploadDate = new Date(file.uploaded_at).toLocaleDateString();
        
        const fileItem = document.createElement('div');
        fileItem.className = `file-item ${isActive ? 'active' : ''}`;
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-name">${file.file_name}</div>
                <div class="file-details">
                    <span>Size: ${fileSize}</span>
                    <span>Uploaded: ${uploadDate}</span>
                    ${isActive ? '<span style="color: #4caf50;">‚úì Active</span>' : ''}
                </div>
            </div>
            <div class="file-actions">
                ${!isActive ? `
                    <button class="file-action-btn set-active-btn" title="Set as Active" onclick="setActiveFile(${file.id})">
                        ‚úì
                    </button>
                ` : ''}
                <button class="file-action-btn" title="Download" onclick="downloadFile('${file.file_url}', '${file.file_name}')">
                    ‚¨áÔ∏è
                </button>
                <button class="file-action-btn delete-file-btn" title="Delete" onclick="showDeleteConfirm(${file.id}, '${file.file_name}')">
                    üóëÔ∏è
                </button>
            </div>
        `;
        
        filesList.appendChild(fileItem);
    });
}

function updatePdfDownloadLink() {
    const downloadLink = document.getElementById('pdf-download-link');
    
    if (activePdfFile) {
        downloadLink.href = activePdfFile.file_url;
        downloadLink.download = activePdfFile.file_name;
        downloadLink.style.display = 'inline-block';
    } else {
        downloadLink.href = '#';
        downloadLink.style.display = 'none';
    }
}

function downloadFile(url, fileName) {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function setActiveFile(fileId) {
    const file = allPdfFiles.find(f => f.id === fileId);
    if (!file) return;
    
    activePdfFile = file;
    updateFilesDisplay();
    updatePdfDownloadLink();
    
    showMessage(`"${file.file_name}" is now the active PDF file`, 'success');
}

// ============ ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ÿ¨ÿØŸäÿØÿ© ============
function handleFileSelect(file) {
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
        alert('Please select a PDF file only!');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File size too large! Maximum size is 10MB.');
        return;
    }
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').textContent = 'Starting upload...';
    
    uploadNewPdf(file);
}

async function uploadNewPdf(file) {
    try {
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
        updateProgress(10, 'Preparing upload...');
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßÿ≥ŸÖ ŸÅÿ±ŸäÿØ ŸÑŸÑŸÖŸÑŸÅ
        const fileExt = file.name.split('.').pop();
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(7);
        const fileName = `farmbot_${timestamp}_${randomStr}.${fileExt}`;
        const filePath = `pdfs/${fileName}`;
        
        updateProgress(30, 'Uploading to Supabase...');
        
        // ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ Supabase Storage
        const { error: uploadError } = await supabaseClient.storage
            .from('website_files')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
        
        if (uploadError) throw uploadError;
        
        updateProgress(60, 'Getting file URL...');
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿπÿßŸÖ
        const { data: { publicUrl } } = supabaseClient.storage
            .from('website_files')
            .getPublicUrl(filePath);
        
        updateProgress(80, 'Saving to database...');
        
        // ÿ≠ÿ≥ÿßÿ® ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ
        const fileSize = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
        
        // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÑŸÅ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const { error: dbError } = await supabaseClient
            .from('website_files')
            .insert([{
                file_name: file.name,
                file_url: publicUrl,
                file_type: 'pdf',
                file_size: fileSize,
                description: 'Farm Bot PDF Document',
                uploaded_at: new Date().toISOString()
            }]);
        
        if (dbError) throw dbError;
        
        updateProgress(100, 'Upload complete!');
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        setTimeout(async () => {
            await loadAllData();
            showMessage(`"${file.name}" uploaded successfully!`, 'success');
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
            setTimeout(() => {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('fileInput').value = '';
            }, 1000);
        }, 500);
        
    } catch (error) {
        console.error('Error uploading PDF:', error);
        document.getElementById('progressText').textContent = 'Error: ' + error.message;
        showMessage('Error uploading PDF: ' + error.message, 'error');
    }
}

function updateProgress(percent, message) {
    document.getElementById('progressFill').style.width = percent + '%';
    document.getElementById('progressText').textContent = message;
}

// ============ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ============
function showDeleteConfirm(fileId, fileName) {
    fileToDelete = fileId;
    document.getElementById('deleteMessage').textContent = 
        `Are you sure you want to delete "${fileName}"? This action cannot be undone.`;
    document.getElementById('confirmDeleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('confirmDeleteModal').style.display = 'none';
    fileToDelete = null;
}

async function confirmDelete() {
    if (!fileToDelete) return;
    
    try {
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ±ÿßÿØ ÿ≠ÿ∞ŸÅŸá
        const file = allPdfFiles.find(f => f.id === fileToDelete);
        if (!file) {
            showMessage('File not found', 'error');
            return;
        }
        
        const fileName = file.file_name;
        
        // ÿ≠ÿ∞ŸÅ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        const { error: dbError } = await supabaseClient
            .from('website_files')
            .delete()
            .eq('id', fileToDelete);
        
        if (dbError) throw dbError;
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ÿ∞ŸàŸÅ ŸáŸà ÿßŸÑŸÜÿ¥ÿ∑ÿå ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ¢ÿÆÿ± ŸÉŸÜÿ¥ÿ∑
        if (activePdfFile && activePdfFile.id === fileToDelete) {
            activePdfFile = null;
        }
        
        closeDeleteModal();
        await loadAllData();
        showMessage(`"${fileName}" deleted successfully`, 'success');
        
    } catch (error) {
        console.error('Error deleting file:', error);
        showMessage('Error deleting file: ' + error.message, 'error');
    }
}

// ============ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ============
function updateWebsiteContent() {
    const lang = currentLang;
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜÿµŸàÿµ
    updateElement('title', textData[lang].main_title);
    updateElement('subtitle', textData[lang].main_subtitle);
    updateElement('about-btn', textData[lang].about_btn);
    updateElement('what-btn', textData[lang].what_btn);
    updateElement('contact-btn', textData[lang].contact_btn);
    updateElement('threeD-btn', textData[lang].threeD_btn);
    updateElement('teachable-btn', textData[lang].teachable_btn);
    updateElement('download-btn', textData[lang].download_btn);
    updateElement('instagram-text', textData[lang].instagram_text);
    
    updateElement('about-page-title', textData[lang].about_title);
    updateElement('about-text', textData[lang].about_text);
    updateElement('what-title', textData[lang].what_title);
    updateElement('teachable-text', textData[lang].teachable_text);
    updateElement('teachable-btn-text', textData[lang].teachable_btn_text);
    updateElement('features-title', textData[lang].features_title);
    updateElement('teachable-note', textData[lang].teachable_note);
    updateElement('download-title', textData[lang].download_title);
    updateElement('download-text', textData[lang].download_text);
    updateElement('download-btn-text', textData[lang].download_btn_text);
    updateElement('file-info', textData[lang].file_info);
    updateElement('suggest-title', textData[lang].suggest_title);
    updateElement('suggest-text', textData[lang].suggest_text);
    updateElement('phone-text', textData[lang].phone_text);
    updateElement('phone-number', textData[lang].contact_phone);
    updateElement('send-btn', textData[lang].send_btn);
    updateElement('exit-about-btn', textData[lang].exit_btn);
    updateElement('exit-what-btn', textData[lang].exit_btn);
    updateElement('exit-teachable-btn', textData[lang].exit_btn);
    updateElement('exit-download-btn', textData[lang].exit_btn);
    
    document.getElementById('suggest-input').placeholder = textData[lang].suggest_placeholder || 'Write your suggestion...';
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑
    if (textData.en.contact_url) {
        document.getElementById('contact-btn').onclick = () => window.open(textData.en.contact_url, '_blank');
    }
    if (textData.en.instagram_url) {
        document.getElementById('instagram-link').href = textData.en.instagram_url;
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
    updateSections();
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element && value !== undefined && value !== null) {
        element.textContent = value;
    }
}

function updateSections() {
    // ÿµŸÅÿ≠ÿ© What it does
    const whatContainer = document.getElementById('functions-content');
    if (whatContainer) {
        whatContainer.innerHTML = '';
        
        const whatSections = websiteSections.filter(s => s.page === 'what');
        
        if (whatSections.length === 0) {
            whatContainer.innerHTML = '<p>No functions available</p>';
        } else {
            whatSections.forEach(section => {
                const div = createSectionElement(section);
                whatContainer.appendChild(div);
            });
        }
    }
    
    // ÿµŸÅÿ≠ÿ© Teachable Machine
    const teachableContainer = document.getElementById('teachable-features');
    if (teachableContainer) {
        teachableContainer.innerHTML = '';
        
        const teachableSections = websiteSections.filter(s => s.page === 'teachable');
        
        if (teachableSections.length === 0) {
            teachableContainer.innerHTML = '<div class="function-item">No features available</div>';
        } else {
            teachableSections.forEach(section => {
                const div = createSectionElement(section);
                teachableContainer.appendChild(div);
            });
        }
    }
}

function createSectionElement(section) {
    const div = document.createElement('div');
    div.className = 'function-item';
    div.setAttribute('data-id', section.id);
    
    const title = currentLang === 'en' ? section.title_en : (section.title_ar || section.title_en);
    const content = currentLang === 'en' ? section.content_en : (section.content_ar || section.content_en);
    
    div.innerHTML = `
        <div class="section-controls">
            <button class="section-btn edit-section-btn" onclick="editExistingSection(${section.id})">‚úèÔ∏è</button>
            <button class="section-btn delete-section-btn" onclick="deleteSection(${section.id})">üóë</button>
        </div>
        <h3>${title}</h3>
        <p>${content}</p>
    `;
    
    return div;
}

// ============ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ÿ±Ÿäÿ± ============
function editText(key, element) {
    currentEditElement = element;
    currentEditKey = key;
    
    document.getElementById('editModalTitle').textContent = `Edit: ${key}`;
    document.getElementById('editModalTextarea').value = element.textContent;
    document.getElementById('editModal').style.display = 'flex';
    document.getElementById('editModalTextarea').focus();
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditElement = null;
    currentEditKey = null;
}

function saveEditedText() {
    if (!currentEditElement || !currentEditKey) return;
    
    const newValue = document.getElementById('editModalTextarea').value.trim();
    
    if (!newValue) {
        alert('Text cannot be empty!');
        return;
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
    currentEditElement.textContent = newValue;
    
    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ± ŸÖÿ§ŸÇÿ™ÿßŸã
    if (!unsavedChanges.texts) unsavedChanges.texts = {};
    unsavedChanges.texts[currentEditKey] = {
        value_en: currentLang === 'en' ? newValue : (textData.en[currentEditKey] || ''),
        value_ar: currentLang === 'ar' ? newValue : (textData.ar[currentEditKey] || '')
    };
    
    closeEditModal();
    showMessage('Change saved locally. Click "Save All" to update website.', 'info');
}

// ============ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ============
function addNewSection(page) {
    currentPageForSection = page;
    document.getElementById('addSectionTitle').textContent = `Add New ${page === 'what' ? 'Function' : 'Feature'}`;
    document.getElementById('sectionTitleInput').value = '';
    document.getElementById('sectionContentInput').value = '';
    document.getElementById('addSectionModal').style.display = 'flex';
}

function closeAddSectionModal() {
    document.getElementById('addSectionModal').style.display = 'none';
    currentPageForSection = null;
}

async function saveNewSection() {
    const title = document.getElementById('sectionTitleInput').value.trim();
    const content = document.getElementById('sectionContentInput').value.trim();
    
    if (!title) {
        alert('Title is required!');
        return;
    }
    
    try {
        const maxOrder = websiteSections
            .filter(s => s.page === currentPageForSection)
            .reduce((max, s) => Math.max(max, s.order_index), 0);
        
        const { data, error } = await supabaseClient
            .from('website_sections')
            .insert([{
                page: currentPageForSection,
                title_en: title,
                title_ar: title,
                content_en: content,
                content_ar: content,
                order_index: maxOrder + 1,
                is_active: true
            }])
            .select();
        
        if (error) throw error;
        
        closeAddSectionModal();
        await loadAllData();
        showMessage('Section added successfully!', 'success');
        
    } catch (error) {
        console.error('Error adding section:', error);
        showMessage('Error adding section', 'error');
    }
}

async function editExistingSection(sectionId) {
    const section = websiteSections.find(s => s.id === sectionId);
    if (!section) return;
    
    const newTitle = prompt('Edit title:', section.title_en);
    if (newTitle === null) return;
    
    const newContent = prompt('Edit content:', section.content_en);
    if (newContent === null) return;
    
    try {
        const { error } = await supabaseClient
            .from('website_sections')
            .update({
                title_en: newTitle,
                content_en: newContent
            })
            .eq('id', sectionId);
        
        if (error) throw error;
        
        await loadAllData();
        showMessage('Section updated successfully!', 'success');
        
    } catch (error) {
        console.error('Error updating section:', error);
        showMessage('Error updating section', 'error');
    }
}

async function deleteSection(sectionId) {
    if (!confirm('Are you sure you want to delete this section?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('website_sections')
            .delete()
            .eq('id', sectionId);
        
        if (error) throw error;
        
        await loadAllData();
        showMessage('Section deleted successfully!', 'success');
        
    } catch (error) {
        console.error('Error deleting section:', error);
        showMessage('Error deleting section', 'error');
    }
}

// ============ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ============
async function saveAllChanges() {
    if (Object.keys(unsavedChanges.texts || {}).length === 0) {
        showMessage('No changes to save', 'info');
        return;
    }
    
    showMessage('Saving all changes...', 'info');
    
    try {
        for (const [key, data] of Object.entries(unsavedChanges.texts)) {
            const updateData = {
                key: key,
                updated_at: new Date().toISOString()
            };
            
            if (data.value_en) updateData.value_en = data.value_en;
            if (data.value_ar) updateData.value_ar = data.value_ar;
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÜÿµ ÿßŸÑÿ≠ÿßŸÑŸä
            const { data: existing } = await supabaseClient
                .from('website_texts')
                .select('*')
                .eq('key', key)
                .single();
            
            if (existing) {
                // ÿ™ÿ≠ÿØŸäÿ´
                await supabaseClient
                    .from('website_texts')
                    .update(updateData)
                    .eq('id', existing.id);
            } else {
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸäÿØ
                await supabaseClient
                    .from('website_texts')
                    .insert([updateData]);
            }
        }
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        await loadAllData();
        unsavedChanges = {};
        showMessage('All changes saved successfully! Website updated.', 'success');
        
    } catch (error) {
        console.error('Error saving changes:', error);
        showMessage('Error saving changes: ' + error.message, 'error');
    }
}

// ============ Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿ≥ÿßÿπÿØÿ© ============
function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = `message ${type} show`;
    
    setTimeout(() => {
        msg.className = 'message';
    }, 3000);
}

function toggleLang() {
    currentLang = currentLang === 'en' ? 'ar' : 'en';
    document.querySelector('.lang-toggle').textContent = currentLang === 'en' ? 'AR' : 'EN';
    document.body.style.direction = currentLang === 'ar' ? 'rtl' : 'ltr';
    updateWebsiteContent();
}

function openPage(pageId) {
    document.getElementById('home').style.display = 'none';
    document.getElementById('suggestions').style.display = 'none';
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    
    const page = document.getElementById(pageId);
    page.style.display = 'block';
    
    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ
    if (pageId === 'what' || pageId === 'teachable') {
        updateSections();
    }
}

function closePage(pageId) {
    document.getElementById(pageId).style.display = 'none';
    document.getElementById('home').style.display = 'flex';
    document.getElementById('suggestions').style.display = 'block';
}

function open3DPage() {
    const url = textData.en.threeD_url || 'https://farmbot1238.github.io/3D/';
    window.open(url, '_blank');
}

function openTeachableModel() {
    const url = textData.en.teachable_url || 'https://farmbot1238.github.io/tomato/';
    window.open(url, '_blank');
}

async function sendSuggestion() {
    const suggestion = document.getElementById('suggest-input').value.trim();
    if (!suggestion) {
        alert('Please write your suggestion first');
        return;
    }
    
    try {
        const { error } = await supabaseClient
            .from('website_suggestions')
            .insert([{ suggestion: suggestion }]);
        
        if (error) throw error;
        
        alert('Thank you for your suggestion!');
        document.getElementById('suggest-input').value = '';
        
    } catch (error) {
        console.error('Error saving suggestion:', error);
        alert('Error saving suggestion');
    }
}

// ============ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ============
function loadDefaultData() {
    textData = {
        en: {
            main_title: 'FARM 8OT',
            main_subtitle: 'Revolution in the world of agriculture',
            about_btn: 'About',
            what_btn: 'What it does',
            contact_btn: 'Contact',
            threeD_btn: '3D',
            teachable_btn: 'Teachable Machine Model',
            download_btn: 'Download PDF',
            instagram_text: 'Follow us on Instagram',
            about_title: 'About',
            about_text: 'Farm Bot is an intelligent agricultural robot...',
            what_title: 'What it does',
            teachable_title_part1: 'Teachable',
            teachable_title_part2: 'Machine',
            teachable_text: 'Experience our AI-powered plant disease detection model...',
            teachable_btn_text: 'Open Teachable Machine Model',
            features_title: 'Features:',
            teachable_note: 'Note: The model will open in a new window...',
            download_title: 'Download Farm Bot PDF',
            download_text: 'Download our comprehensive PDF document...',
            download_btn_text: 'Download Farm Bot PDF',
            file_info: 'File size: 1.2 MB | Format: PDF',
            suggest_title: 'Suggestions',
            suggest_text: 'We believe in any suggestion that can develop and enhance our project.',
            phone_text: 'Phone:',
            contact_phone: '+962 7XXXXXXXX',
            send_btn: 'Send',
            exit_btn: 'Exit'
        },
        ar: {
            main_title: 'FARM 8OT',
            main_subtitle: 'ÿ´Ÿàÿ±ÿ© ŸÅŸä ÿπÿßŸÑŸÖ ÿßŸÑÿ≤ÿ±ÿßÿπÿ©',
            about_btn: 'ÿ≠ŸàŸÑ',
            what_btn: 'ŸÖÿßÿ∞ÿß ŸäŸÅÿπŸÑ',
            contact_btn: 'ÿ™ŸàÿßÿµŸÑ',
            threeD_btn: '3D',
            teachable_btn: 'ŸÜŸÖŸàÿ∞ÿ¨ Teachable Machine',
            download_btn: 'ÿ™ÿ≠ŸÖŸäŸÑ PDF',
            instagram_text: 'ÿ™ÿßÿ®ÿπŸÜÿß ÿπŸÑŸâ ÿßŸÑÿ•ŸÜÿ≥ÿ™ÿ¨ÿ±ÿßŸÖ',
            about_title: 'ÿ≠ŸàŸÑ',
            about_text: 'ÿßŸÑŸÖÿ≤ÿ±ÿπÿ© ÿßŸÑÿ∞ŸÉŸäÿ© ŸáŸà ÿ±Ÿàÿ®Ÿàÿ™ ÿ≤ÿ±ÿßÿπŸä ÿ∞ŸÉŸä...',
            what_title: 'ŸÖÿßÿ∞ÿß ŸäŸÅÿπŸÑ',
            teachable_title_part1: 'Teachable',
            teachable_title_part2: 'Machine',
            teachable_text: 'ÿ¨ÿ±ÿ® ŸÜŸÖŸàÿ∞ÿ¨ŸÜÿß ŸÑŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÜÿ®ÿßÿ™ÿßÿ™ ÿßŸÑŸÖÿØÿπŸàŸÖ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä...',
            teachable_btn_text: 'ŸÅÿ™ÿ≠ ŸÜŸÖŸàÿ∞ÿ¨ Teachable Machine',
            features_title: 'ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™:',
            teachable_note: 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©...',
            download_title: 'ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ PDF ŸÑŸÑŸÖÿ≤ÿ±ÿπÿ© ÿßŸÑÿ∞ŸÉŸäÿ©',
            download_text: 'ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿ´ŸäŸÇÿ© PDF ÿßŸÑÿ¥ÿßŸÖŸÑÿ©...',
            download_btn_text: 'ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ PDF ŸÑŸÑŸÖÿ≤ÿ±ÿπÿ© ÿßŸÑÿ∞ŸÉŸäÿ©',
            file_info: 'ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ: 1.2 ŸÖŸäÿ¨ÿßÿ®ÿßŸäÿ™ | ÿßŸÑÿµŸäÿ∫ÿ©: PDF',
            suggest_title: 'ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™',
            suggest_text: 'ŸÜÿ≠ŸÜ ŸÜÿ§ŸÖŸÜ ÿ®ÿ£Ÿä ÿßŸÇÿ™ÿ±ÿßÿ≠ ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿ∑Ÿàÿ± ŸàŸäÿπÿ≤ÿ≤ ŸÖÿ¥ÿ±ŸàÿπŸÜÿß.',
            phone_text: 'Ÿáÿßÿ™ŸÅ:',
            contact_phone: '+962 7XXXXXXXX',
            send_btn: 'ÿ•ÿ±ÿ≥ÿßŸÑ',
            exit_btn: 'ÿÆÿ±Ÿàÿ¨'
        }
    };
    
    websiteSections = [];
    allPdfFiles = [];
    activePdfFile = null;
    
    updateWebsiteContent();
    updateFilesDisplay();
    showMessage('Using default data (no database connection)', 'info');
}
</script>
</body>
</html>
